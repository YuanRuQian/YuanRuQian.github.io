<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>heatmap.js 源码学习笔记 · Lydia Yuan's Blog</title><meta name="description" content="heatmap.js 源码学习笔记 - Lydia Yuan"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/gandalfr.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/solarized-light.min.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Lydia Yuan's Blog"><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Lydia Yuan's Blog" type="application/atom+xml">
<!-- hexo-inject:begin --><!-- hexo-inject:end --></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/YuanRuQian" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="mailto:lydiayuan99@gmail.com" target="_self" class="nav-list-link">E-MAIL</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">heatmap.js 源码学习笔记</h1><div class="tags"><a href="/tags/JavaDcript/" class="tag-title">#JavaDcript</a><a href="/tags/Design/" class="tag-title">#Design</a></div><div class="post-info">Dec 12, 2020</div><div class="post-content"><h3 id="变量声明-函数立即执行">变量声明 =&gt; 函数立即执行</h3>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><p>首先 我发现有很多这样的写法 ⬇️ <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Renderer = (<span class="function"><span class="keyword">function</span> <span class="title">RendererClosure</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> rendererFn = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (HeatmapConfig[<span class="string">&#x27;defaultRenderer&#x27;</span>] === <span class="string">&#x27;canvas2d&#x27;</span>) &#123;</span><br><span class="line">    rendererFn = Canvas2dRenderer;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rendererFn;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></p>
<p>乍一看不太能理解 所以我自己写了一个最简单的同形式例子来测试 ⬇️ <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> test = (<span class="function"><span class="keyword">function</span> <span class="title">logger</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;logger...&#x27;</span>)</span><br><span class="line">&#125;) ();</span><br><span class="line"><span class="comment">// logger...</span></span><br></pre></td></tr></table></figure> 说明 <code>logger</code> 在声明时就立刻执行</p>
<h3 id="需要哪些参数">需要哪些参数</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Heatmap Config stores default values and will be merged with instance config</span></span><br><span class="line"><span class="keyword">var</span> HeatmapConfig = &#123;</span><br><span class="line">  defaultRadius: <span class="number">40</span>,</span><br><span class="line">  defaultRenderer: <span class="string">&#x27;canvas2d&#x27;</span>,</span><br><span class="line">  defaultGradient: &#123; <span class="number">0.25</span>: <span class="string">&quot;rgb(0,0,255)&quot;</span>, <span class="number">0.55</span>: <span class="string">&quot;rgb(0,255,0)&quot;</span>, <span class="number">0.85</span>: <span class="string">&quot;yellow&quot;</span>, <span class="number">1.0</span>: <span class="string">&quot;rgb(255,0,0)&quot;</span>&#125;,</span><br><span class="line">  defaultMaxOpacity: <span class="number">1</span>,</span><br><span class="line">  defaultMinOpacity: <span class="number">0</span>,</span><br><span class="line">  defaultBlur: <span class="number">.85</span>,</span><br><span class="line">  defaultXField: <span class="string">&#x27;x&#x27;</span>,</span><br><span class="line">  defaultYField: <span class="string">&#x27;y&#x27;</span>,</span><br><span class="line">  defaultValueField: <span class="string">&#x27;value&#x27;</span>, </span><br><span class="line">  plugins: &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 我觉得自己实现的话 如何实现渐变是很难的一个点</span></span><br><span class="line"><span class="comment">// rgb(0,0,255) 蓝色</span></span><br><span class="line"><span class="comment">// rgb(0,255,0) 绿色</span></span><br><span class="line"><span class="comment">// yellow 就黄色 没啥好讲的</span></span><br><span class="line"><span class="comment">// rgb(255,0,0) 红色</span></span><br><span class="line"><span class="comment">// 所以渐变是 0.25 处 蓝色 =&gt; 0.55 处 绿色 =&gt; 0.85 处 黄色 =&gt; 1.0 处 红色 的变化</span></span><br></pre></td></tr></table></figure>
<h3 id="merge-函数">merge 函数</h3>
<p>上一段刚刚提到 <code>Heatmap Config stores default values and will be merged with instance config</code> 那么来看看 <code>merge</code> 在这里是如何实现的 ⬇️</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> merge = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> merged = &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> argsLen = <span class="built_in">arguments</span>.length;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; argsLen; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> obj = <span class="built_in">arguments</span>[i]</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">      merged[key] = obj[key];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> merged;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试</span></span><br><span class="line"><span class="keyword">var</span> config = merge(&#123;<span class="attr">a</span>: <span class="string">&#x27;a&#x27;</span>&#125;, &#123; <span class="attr">test</span>: <span class="string">&#x27;test&#x27;</span>&#125; );</span><br><span class="line"><span class="built_in">console</span>.log(config);</span><br><span class="line"><span class="comment">// &#123;a: &quot;a&quot;, test: &quot;test&quot;&#125;</span></span><br></pre></td></tr></table></figure>
<p>其实就是很简单的遍历一遍传入的 <code>Object</code> 的 <code>key</code> 然后加到新的空对象上 不过注意如果使用 <code>arguments</code> 的话 请不要使用箭头函数 因为箭头函数本身没有绑定的 <code>arguments</code></p>
<p>如果是普通函数的话 ⬇️ <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="built_in">arguments</span>) &#125;</span><br><span class="line">func.arguments</span><br><span class="line"><span class="comment">// null</span></span><br></pre></td></tr></table></figure></p>
<p>如果是箭头函数 ⬇️ <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arrow = <span class="function">() =&gt;</span> &#123; <span class="built_in">console</span>.log(args) &#125;</span><br><span class="line">arrow.arguments</span><br><span class="line"><span class="comment">// 报错</span></span><br><span class="line"><span class="comment">//VM769:1 Uncaught TypeError: &#x27;caller&#x27;, &#x27;callee&#x27;, and &#x27;arguments&#x27; properties may not be accessed on strict mode functions or the arguments objects for calls to them</span></span><br></pre></td></tr></table></figure></p>
<h3 id="渐变是如何实现的">渐变是如何实现的</h3>
<p>是这个 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/createLinearGradient">CanvasRenderingContext2D.createLinearGradient()</a> API</p>
</div></article></div></main><footer><div class="paginator"><a href="/2020/12/18/JS-%E5%B0%86%E6%95%B0%E5%AD%97%E8%BD%AC%E6%8D%A2%E4%B8%BA%E8%B4%A7%E5%B8%81%E5%BD%A2%E5%BC%8F/" class="prev">PREV</a><a href="/2020/12/05/%E5%AE%9E%E7%8E%B0-Array-prototype-reduce/" class="next">NEXT</a></div><div class="copyright"><p>© 2020 <a href="http://yoursite.com">Lydia Yuan</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/MikeCoder/hexo-theme-gandalfr" target="_blank">hexo-theme-gandalfr</a>.</p></div></footer></div><script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js" crossorigin="anonymous"></script><script src="//cdn.bootcss.com/jquery/3.1.1/jquery.js" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-164777506-1",'auto');ga('send','pageview');</script><script>$(document).ready(function() { hljs.configure({useBR: true}); $('pre').each(function(i, block) { hljs.highlightBlock(block); }); });</script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({{ JSON.stringify(config) }});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="{{ src }}">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end --></body></html>